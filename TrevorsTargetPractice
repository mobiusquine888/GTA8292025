<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cletus Ewing's Target Practice | GTA FastLane</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800;900&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ff1a1a;
            --secondary: #00ff9d;
            --accent: #ffea00;
            --bg: #0a0a0a;
            --card: #1a1a1a;
            --text: #ffffff;
            --shadow: 0 0 30px rgba(255, 26, 26, 0.5);
            --glow: 0 0 20px rgba(255, 255, 0.8);
            --gold: #ffd700;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        *::selection { background: var(--accent); color: #000; }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Montserrat', sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0.5rem;
            gap: 0.5rem;
            max-width: 100vw;
            max-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #ff1a1a, #8b0000);
            padding: 0.8rem 1rem;
            text-align: center;
            border-radius: 12px;
            box-shadow: var(--shadow);
            font-family: 'Orbitron', monospace;
            letter-spacing: 2px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 15px rgba(255, 26, 26, 0.6); }
            50% { box-shadow: 0 0 35px rgba(255, 26, 26, 1); }
        }

        .header h1 {
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            font-weight: 900;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            background: rgba(26, 26, 26, 0.9);
            padding: 0.6rem 1rem;
            border-radius: 10px;
            font-size: clamp(0.7rem, 2.5vw, 0.9rem);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 26, 26, 0.3);
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 60px;
        }

        .stat-value {
            font-weight: 900;
            color: var(--secondary);
            text-shadow: 0 0 8px var(--secondary);
        }

        .stat-label {
            font-size: 0.65rem;
            opacity: 0.8;
            margin-top: 2px;
        }

        .game-area {
            position: relative;
            flex: 1;
            background: #0d1b2a;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: inset 0 0 40px rgba(0,0,0,0.8), 0 0 20px rgba(255, 26, 26, 0.3);
            cursor: crosshair;
            min-height: 300px;
        }

        #targetRange {
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 50% 30%, #87CEEB 0%, #DAA520 60%, #8B4513 100%),
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%238B4513"/><circle cx="50" cy="50" r="30" fill="%23DAA520"/><circle cx="50" cy="50" r="20" fill="%2387CEEB"/></svg>');
            background-size: cover, 200px 200px;
            position: relative;
            overflow: hidden;
        }

        #scopeOverlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            background: radial-gradient(circle at center, transparent 35%, rgba(0,0,0,0.85) 60%);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 5;
        }

        #crosshair {
            position: absolute;
            width: 40px; height: 40px;
            top: 50%; left: 50%;
            margin: -20px 0 0 -20px;
            pointer-events: none;
            z-index: 10;
            transition: all 0.05s ease;
        }

        #crosshair::before, #crosshair::after {
            content: '';
            position: absolute;
            background: var(--primary);
            box-shadow: 0 0 10px var(--primary);
        }

        #crosshair::before {
            width: 100%; height: 4px;
            top: 50%; left: 0;
            margin-top: -2px;
        }

        #crosshair::after {
            width: 4px; height: 100%;
            left: 50%; top: 0;
            margin-left: -2px;
        }

        .target {
            position: absolute;
            pointer-events: none;
            user-select: none;
            transition: transform 0.1s ease;
        }

        .target-circle {
            width: 50px; height: 50px;
            background: conic-gradient(from 0deg, white 0deg, red 90deg, white 180deg, red 270deg, white 360deg);
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 0 15px rgba(255,255,255,0.8), inset 0 0 10px rgba(0,0,0,0.5);
            animation: float 3s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .target-satellite {
            width: 50px; height: 50px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="%23666"/><circle cx="50" cy="50" r="38" fill="%23999"/><circle cx="50" cy="50" r="30" fill="%23ccc"/><path d="M20 50 Q10 40 15 30 Q20 25 30 30 L35 35 L40 30 Q45 25 50 30 L55 35 L60 30 Q65 25 70 30 L75 35 L80 30 Q85 25 90 30 Q95 40 85 50 L80 60 Q75 70 70 65 L60 60 L50 65 Q40 70 30 65 L20 60 Z" fill="%23aaa"/><circle cx="50" cy="50" r="12" fill="%23000"/><circle cx="50" cy="50" r="8" fill="%23fff"/></svg>');
            background-size: cover;
        }

        .target-car {
            width: 80px; height: 40px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 160 80"><rect x="10" y="20" width="140" height="40" rx="10" fill="%23033"/><rect x="20" y="30" width="120" height="20" fill="%23c00"/><circle cx="35" cy="60" r="12" fill="%23000"/><circle cx="125" cy="60" r="12" fill="%23000"/></svg>');
            background-size: cover;
        }

        .target-tire {
            width: 16px; height: 16px;
            background: radial-gradient(circle, #111 40%, #333 100%);
            border-radius: 50%;
            border: 2px solid #000;
            box-shadow: 0 0 8px rgba(0,0,0,0.8);
        }

        .target-coyote {
            width: 50px; height: 40px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 80"><path d="M20 40 Q10 30 15 20 Q20 15 30 20 L40 25 L50 20 Q60 15 65 20 L70 25 L80 20 Q85 15 90 20 Q95 30 85 40 L80 50 Q75 60 70 55 L60 50 L50 55 Q40 60 30 55 L20 50 Z" fill="%23a52"/><circle cx="35" cy="35" r="8" fill="%23000"/><circle cx="65" cy="35" r="8" fill="%23000"/><circle cx="37" cy="33" r="3" fill="%23fff"/><circle cx="67" cy="33" r="3" fill="%23fff"/></svg>');
            background-size: cover;
        }

        .rooftop-line {
            position: absolute;
            left: 0; right: 0; bottom: 35%;
            height: 3px;
            background: #555;
            box-shadow: 0 0 10px rgba(0,0,0,0.8);
            z-index: 1;
        }

        .explosion {
            position: absolute;
            width: 60px; height: 60px;
            background: radial-gradient(circle, #ff4500, #ff8c00, transparent);
            border-radius: 50%;
            pointer-events: none;
            animation: explode 0.6s ease-out forwards;
            z-index: 6;
        }

        @keyframes explode {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(3); opacity: 0; }
        }

        .controls {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.7rem 1.2rem;
            border: none;
            border-radius: 10px;
            font-weight: 800;
            font-size: clamp(0.8rem, 2.5vw, 1rem);
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-mode {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid transparent;
        }

        .btn-mode.active {
            background: var(--secondary);
            color: #000;
            border-color: var(--secondary);
            box-shadow: var(--glow);
        }

        .btn-start {
            background: linear-gradient(45deg, var(--primary), var(--accent));
            color: white;
            flex: 1;
            max-width: 300px;
            box-shadow: var(--shadow);
        }

        .btn-start:hover, .btn-mode:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(255, 26, 26, 0.4);
        }

        .instructions {
            text-align: center;
            padding: 0.5rem;
            font-weight: 700;
            color: var(--secondary);
            text-shadow: 0 0 10px var(--secondary);
            font-size: clamp(0.8rem, 2.5vw, 1rem);
            min-height: 2.5em;
        }

        .game-over {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            border: 3px solid var(--primary);
            box-shadow: 0 0 50px rgba(255, 26, 26, 0.8);
            z-index: 100;
            display: none;
            max-width: 90%;
        }

        .gold-medal {
            font-size: 3rem;
            color: var(--gold);
            text-shadow: 0 0 20px var(--gold);
            animation: gold-pulse 1.5s infinite;
        }

        @keyframes gold-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .medals {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .medal {
            text-align: center;
            min-width: 80px;
        }

        .medal-name {
            font-size: 0.7rem;
            opacity: 0.8;
        }

        .medal-icon {
            font-size: 1.5rem;
            margin: 0.3rem 0;
        }

        @media (max-width: 768px) {
            .stats-bar { padding: 0.4rem 0.6rem; }
            .btn { padding: 0.6rem 0.8rem; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1>CLETUS EWING'S TARGET PRACTICE</h1>
        </div>

        <div class="stats-bar">
            <div class="stat">
                <div class="stat-value" id="targetStage">1/4</div>
                <div class="stat-label">STAGE</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="targetAccuracy">100%</div>
                <div class="stat-label">ACCURACY</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="targetTimer">90s</div>
                <div class="stat-label">TIME</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="targetGold">0/4</div>
                <div class="stat-label">GOLD</div>
            </div>
        </div>

        <div class="game-area" id="gameArea">
            <div id="targetRange">
                <div id="scopeOverlay"></div>
                <div id="crosshair"></div>
                <div id="rooftopLine" class="rooftop-line" style="display: none;"></div>
            </div>
        </div>

        <div class="instructions" id="targetInstructions">SELECT DIFFICULTY TO BEGIN</div>

        <div class="controls">
            <button class="btn btn-mode" id="modeEasy">EASY</button>
            <button class="btn btn-mode" id="modeMedium">MEDIUM</button>
            <button class="btn btn-mode active" id="modeHard">HARD</button>
            <button class="btn btn-start" id="targetStartBtn">START SHOOTIN'</button>
        </div>

        <div class="game-over" id="targetGameOver">
            <div id="targetResult" style="font-size: 2rem; margin-bottom: 1rem;"></div>
            <div id="targetFinalScore" style="margin-bottom: 1rem; font-weight: 700;"></div>
            <div class="medals" id="goldMedals"></div>
            <button class="btn btn-start" onclick="location.reload()" style="margin-top: 1.5rem;">PLAY AGAIN</button>
        </div>
    </div>

    <script>
        // FINAL FIX: STAGE 4 COYOTES ON ROOFTOP â€” 100% WORKING
        let state = {
            stage: 1, mode: 'hard', timeLeft: 45, score: 0,
            shots: 0, hits: 0, accuracy: 100,
            circles: 0, satellites: 0, tires: 0, coyotes: 0, doubleKills: 0,
            gold: { circles: false, satellites: false, tires: false, coyotes: false },
            playing: false, timer: null, audioCtx: null,
            targets: [], vehicles: [], coyotes: []
        };

        const config = {
            easy: { time: 90, circleReq: 5, satReq: 3, tireReq: 3, coyoteReq: 3, accReq: 60, doubleReq: 0, speed: 1.0 },
            medium: { time: 60, circleReq: 7, satReq: 3, tireReq: 4, coyoteReq: 4, accReq: 75, doubleReq: 1, speed: 1.5 },
            hard: { time: 45, circleReq: 10, satReq: 4, tireReq: 5, coyoteReq: 5, accReq: 85, doubleReq: 2, speed: 2.2 }
        };

        // Audio
        function initAudio() {
            state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playSound(type, freq = 800, duration = 0.1) {
            if (!state.audioCtx) return;
            const osc = state.audioCtx.createOscillator();
            const gain = state.audioCtx.createGain();
            osc.connect(gain); gain.connect(state.audioCtx.destination);
            osc.type = type === 'hit' ? 'sine' : type === 'miss' ? 'square' : 'sawtooth';
            osc.frequency.setValueAtTime(freq, state.audioCtx.currentTime);
            if (type === 'gunshot') osc.frequency.exponentialRampToValueAtTime(200, state.audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.3, state.audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, state.audioCtx.currentTime + duration);
            osc.start(); osc.stop(state.audioCtx.currentTime + duration);
        }

        function speak(text) {
            const msg = new SpeechSynthesisUtterance(text);
            msg.rate = 0.9; msg.pitch = 0.7;
            const voices = speechSynthesis.getVoices();
            const male = voices.find(v => v.lang.includes('en') && v.name.includes('Daniel'));
            if (male) msg.voice = male;
            speechSynthesis.speak(msg);
        }

        // Mode Selection
        ['Easy', 'Medium', 'Hard'].forEach(m => {
            const btn = document.getElementById(`mode${m}`);
            btn.onclick = () => {
                state.mode = m.toLowerCase();
                document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('targetInstructions').textContent = `MODE: ${m.toUpperCase()} | READY TO SHOOT`;
            };
        });

        // Start Game
        document.getElementById('targetStartBtn').onclick = () => {
            initAudio();
            const cfg = config[state.mode];
            Object.assign(state, {
                stage: 1, timeLeft: cfg.time, score: 0, shots: 0, hits: 0, accuracy: 100,
                circles: 0, satellites: 0, tires: 0, coyotes: 0, doubleKills: 0,
                gold: { circles: false, satellites: false, tires: false, coyotes: false },
                playing: true, targets: [], vehicles: [], coyotes: []
            });

            document.getElementById('targetGameOver').style.display = 'none';
            document.getElementById('targetStartBtn').disabled = true;
            document.getElementById('scopeOverlay').style.opacity = '1';
            document.getElementById('rooftopLine').style.display = 'none';

            updateStats();
            nextStage();
            state.timer = setInterval(() => {
                state.timeLeft--;
                document.getElementById('targetTimer').textContent = state.timeLeft + 's';
                if (state.timeLeft <= 0) endGame();
            }, 1000);

            const area = document.getElementById('gameArea');
            area.addEventListener('click', shoot);
            area.addEventListener('mousemove', e => moveCrosshair(e));
            area.addEventListener('touchstart', e => { e.preventDefault(); moveCrosshair(e.touches[0]); shoot(e.touches[0]); }, { passive: false });
        };

        function moveCrosshair(e) {
            const cross = document.getElementById('crosshair');
            const rect = document.getElementById('targetRange').getBoundingClientRect();
            cross.style.left = (e.clientX - rect.left) + 'px';
            cross.style.top = (e.clientY - rect.top) + 'px';
        }

        function updateStats() {
            document.getElementById('targetStage').textContent = `${state.stage}/4`;
            document.getElementById('targetAccuracy').textContent = state.accuracy + '%';
            document.getElementById('targetTimer').textContent = state.timeLeft + 's';
            document.getElementById('targetGold').textContent = `${Object.values(state.gold).filter(v => v).length}/4`;
        }

        function nextStage() {
            clearTargets();
            const cfg = config[state.mode];
            const stages = {
                1: { text: 'Cletus: "Hit them bullseyes, boy!"', spawn: () => spawnTargets(cfg.circleReq) },
                2: { text: 'Cletus: "Blast them satellites!"', spawn: () => spawnSatellites(cfg.satReq) },
                3: { text: 'Cletus: "Pop them tires!"', spawn: () => spawnVehicles(cfg.tireReq) },
                4: { text: 'Cletus: "Line up them coyotes on the roof!"', spawn: () => spawnCoyotesOnRoof(cfg.coyoteReq) }
            };
            const s = stages[state.stage];
            document.getElementById('targetInstructions').textContent = s.text;
            speak(s.text.split(':')[1]?.trim() || s.text);

            if (state.stage === 4) {
                document.getElementById('rooftopLine').style.display = 'block';
            } else {
                document.getElementById('rooftopLine').style.display = 'none';
            }

            setTimeout(s.spawn, 1800);
        }

        function clearTargets() {
            [...state.targets, ...state.vehicles, ...state.coyotes].forEach(t => t.el?.remove());
            state.targets = []; state.vehicles = []; state.coyotes = [];
        }

        function spawnTargets(count) {
            const range = document.getElementById('targetRange');
            for (let i = 0; i < count; i++) {
                const target = document.createElement('div');
                target.className = 'target target-circle';
                target.style.left = `${15 + Math.random() * 70}%`;
                target.style.top = `${20 + Math.random() * 60}%`;
                range.appendChild(target);
                state.targets.push({ el: target, hit: false });
            }
        }

        function spawnSatellites(count) {
            const range = document.getElementById('targetRange');
            for (let i = 0; i < count; i++) {
                const sat = document.createElement('div');
                sat.className = 'target target-satellite';
                sat.style.left = `${10 + i * 20}%`;
                sat.style.top = `${25 + (i % 2) * 30}%`;
                range.appendChild(sat);
                state.targets.push({ el: sat, hit: false });
            }
        }

        function spawnVehicles(count) {
            const range = document.getElementById('targetRange');
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const car = document.createElement('div');
                    car.className = 'target target-car';
                    car.style.left = '-15%';
                    car.style.top = `${30 + (i % 3) * 20}%`;
                    range.appendChild(car);

                    const speed = 3500 / config[state.mode].speed;
                    const anim = car.animate([{ left: '-15%' }, { left: '115%' }], { duration: speed, easing: 'linear' });
                    anim.onfinish = () => car.remove();

                    const tire1 = createTire(car, '18%', '75%');
                    const tire2 = createTire(car, '72%', '75%');
                    state.vehicles.push({ el: car, tires: [tire1, tire2], popped: 0 });
                }, i * 2000);
            }
        }

        function createTire(parent, left, top) {
            const tire = document.createElement('div');
            tire.className = 'target target-tire';
            tire.style.left = left; tire.style.top = top;
            parent.appendChild(tire);
            return tire;
        }

        function spawnCoyotesOnRoof(count) {
            const range = document.getElementById('targetRange');
            const roofY = range.offsetHeight * 0.35; // Match .rooftop-line bottom: 35%

            for (let i = 0; i < count; i++) {
                const coy = document.createElement('div');
                coy.className = 'target target-coyote';
                coy.style.bottom = `${roofY + 10}px`; // Just above the line
                coy.style.left = `${15 + i * 15}%`;
                range.appendChild(coy);

                const obj = { el: coy, hit: false, pos: i };
                state.coyotes.push(obj);

                // Coyote jumps between roof positions
                const moveCoyote = () => {
                    if (!coy.parentElement || obj.hit) return;
                    const positions = [15, 30, 45, 60, 75];
                    const newPos = positions.filter(p => p !== parseInt(coy.style.left)).sort(() => Math.random() - 0.5)[0];
                    coy.style.transition = 'left 1.2s ease-in-out, transform 0.3s';
                    coy.style.left = `${newPos}%`;
                    coy.style.transform = 'translateY(-8px)';
                    setTimeout(() => { if (coy.parentElement) coy.style.transform = 'translateY(0)'; }, 600);
                    setTimeout(moveCoyote, 2000 + Math.random() * 1500);
                };
                setTimeout(moveCoyote, 1000 + i * 500);
            }
        }

        function shoot(e) {
            if (!state.playing) return;
            playSound('gunshot');
            state.shots++;
            const rect = document.getElementById('targetRange').getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            let hit = false, multi = 0;
            const hitCoyotes = [];

            // Stage-specific hit detection
            if (state.stage === 1) {
                for (let i = state.targets.length - 1; i >= 0; i--) {
                    const t = state.targets[i];
                    if (t.hit || !t.el.parentElement) continue;
                    const r = t.el.getBoundingClientRect();
                    if (x > r.left - rect.left && x < r.right - rect.left && y > r.top - rect.top && y < r.bottom - rect.top) {
                        t.hit = true; t.el.style.transform = 'scale(0.3)'; hit = true;
                        state.circles++;
                        setTimeout(() => t.el.remove(), 400);
                        createExplosion(x, y);
                        playSound('hit', 800);
                        break;
                    }
                }
            }

            if (state.stage === 2) {
                for (let i = state.targets.length - 1; i >= 0; i--) {
                    const t = state.targets[i];
                    if (t.hit || !t.el.parentElement) continue;
                    const r = t.el.getBoundingClientRect();
                    if (x > r.left - rect.left && x < r.right - rect.left && y > r.top - rect.top && y < r.bottom - rect.top) {
                        t.hit = true; t.el.style.transform = 'scale(1.8)'; hit = true;
                        state.satellites++;
                        setTimeout(() => t.el.remove(), 500);
                        createExplosion(x, y);
                        playSound('hit', 600);
                        break;
                    }
                }
            }

            if (state.stage === 3) {
                state.vehicles.forEach(v => {
                    if (!v.el.parentElement) return;
                    v.tires.forEach(tire => {
                        if (!tire.parentElement) return;
                        const r = tire.getBoundingClientRect();
                        if (x > r.left - rect.left && x < r.right - rect.left && y > r.top - rect.top && y < r.bottom - rect.top) {
                            tire.style.background = '#666'; tire.style.transform = 'scale(1.5)';
                            hit = true; v.popped = (v.popped || 0) + 1; state.tires++;
                            playSound('hit', 400, 0.2);
                            if (v.popped >= 2) v.el.style.transform = 'rotate(25deg)';
                            setTimeout(() => tire.remove(), 300);
                        }
                    });
                });
            }

            if (state.stage === 4) {
                state.coyotes.forEach(c => {
                    if (c.hit || !c.el.parentElement) return;
                    const r = c.el.getBoundingClientRect();
                    if (x > r.left - rect.left && x < r.right - rect.left && y > r.top - rect.top && y < r.bottom - rect.top) {
                        c.hit = true; hitCoyotes.push(c);
                    }
                });

                if (hitCoyotes.length > 0) {
                    hit = true; multi = hitCoyotes.length;
                    state.coyotes = state.coyotes.filter(c => !c.hit);
                    if (multi > 1) state.doubleKills++;
                    hitCoyotes.forEach(c => {
                        c.el.style.transform = 'scale(1.6) rotate(20deg)';
                        setTimeout(() => c.el.remove(), 600);
                    });
                    createExplosion(x, y, multi > 1 ? '2 FOR 1!' : '');
                    playSound('hit', 900);
                }
            }

            if (hit) {
                state.hits++;
                state.score += 100 * (multi || 1);
            } else {
                playSound('miss', 300, 0.05);
            }

            state.accuracy = state.shots > 0 ? Math.round((state.hits / state.shots) * 100) : 100;
            updateStats();
            checkStageComplete();
        }

        function createExplosion(x, y, text = '') {
            const exp = document.createElement('div');
            exp.className = 'explosion';
            if (text) exp.textContent = text;
            exp.style.left = (x - 30) + 'px';
            exp.style.top = (y - 30) + 'px';
            document.getElementById('targetRange').appendChild(exp);
            setTimeout(() => exp.remove(), 600);
        }

        function checkStageComplete() {
            const cfg = config[state.mode];
            let complete = false;

            if (state.stage === 1 && state.circles >= cfg.circleReq) complete = true;
            else if (state.stage === 2 && state.satellites >= cfg.satReq) complete = true;
            else if (state.stage === 3 && state.tires >= cfg.tireReq) complete = true;
            else if (state.stage === 4 && state.coyotes.length === 0) complete = true;

            if (complete && state.stage < 4) {
                state.stage++;
                setTimeout(nextStage, 1800);
            } else if (complete && state.stage === 4) {
                endGame();
            }
        }

        function endGame() {
            if (!state.playing) return;
            state.playing = false;
            clearInterval(state.timer);
            document.getElementById('targetStartBtn').disabled = false;
            document.getElementById('scopeOverlay').style.opacity = '0';
            document.getElementById('rooftopLine').style.display = 'none';

            const cfg = config[state.mode];
            const gold = {
                circles: state.circles >= cfg.circleReq && state.shots === state.hits,
                satellites: state.satellites >= cfg.satReq && state.shots === state.hits,
                tires: state.tires >= cfg.tireReq && state.accuracy >= cfg.accReq,
                coyotes: state.coyotes.length === 0 && state.doubleKills >= cfg.doubleReq
            };
            state.gold = gold;
            const count = Object.values(gold).filter(v => v).length;

            document.getElementById('targetResult').innerHTML = count === 4 ? 
                '<div class="gold-medal">GOLD MEDAL!</div>' : 
                count > 0 ? 'MISSION COMPLETE' : 'MISSION FAILED';

            document.getElementById('targetFinalScore').textContent = 
                `SCORE: ${state.score} | ACC: ${state.accuracy}% | 2x KILLS: ${state.doubleKills}`;

            document.getElementById('goldMedals').innerHTML = `
                <div class="medal"><div class="medal-name">Bullseye</div><div class="medal-icon">${gold.circles ? 'Gold' : 'Failed'}</div></div>
                <div class="medal"><div class="medal-name">Satellite</div><div class="medal-icon">${gold.satellites ? 'Gold' : 'Failed'}</div></div>
                <div class="medal"><div class="medal-name">Pop! Pop!</div><div class="medal-icon">${gold.tires ? 'Gold' : 'Failed'}</div></div>
                <div class="medal"><div class="medal-name">2 for 1</div><div class="medal-icon">${gold.coyotes ? 'Gold' : 'Failed'}</div></div>
            `;

            document.getElementById('targetGameOver').style.display = 'block';
            if (count === 4) speak("Yee-haw! All gold, partner!");
        }

        // Preload
        window.speechSynthesis?.getVoices();
    </script>
</body>
</html>
